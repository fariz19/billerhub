<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BillerHub</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#e8f5e9;}
.header{background:#1fa855;color:white;text-align:center;padding:15px;font-size:22px;font-weight:bold;}
.container{max-width:400px;margin:20px auto;background:white;padding:20px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
input{width:100%;padding:10px;margin-top:10px;border-radius:6px;border:1px solid #ccc;font-size:16px;}
button{width:100%;padding:12px;margin-top:12px;border:none;border-radius:6px;background:#1fa855;color:white;font-size:16px;cursor:pointer;}
button:hover{background:#148f43;}
.hidden{display:none;}
.modern-card{background:white;padding:15px;margin-top:12px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.08);border-left:5px solid #1fa855;}
.modern-card .title{font-weight:bold;font-size:16px;margin-bottom:8px;color:#1fa855;}
.row{display:flex;justify-content:space-between;font-size:14px;margin-top:4px;}
#loading{text-align:center;margin:10px 0;}
.summary{margin-top:10px;padding:10px;background:#f1f8f2;border-radius:8px;font-size:14px;}
.filter-box{margin-top:10px;margin-bottom:10px;}
select, .radio-group{width:100%;padding:8px;margin-top:5px;border-radius:6px;border:1px solid #ccc;font-size:14px;}
</style>
</head>
<body>

<div class="header">BillerHub</div>

<div class="container" id="loginBox">
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Masuk</button>
  <div id="errorMsg" style="color:red;margin-top:10px;"></div>
</div>

<div class="container hidden" id="menuBox">
  <div id="summaryBox" class="summary"></div>
  <div id="pivotBox" class="summary"></div>
  <button onclick="loadData('getDatung')">ðŸ“Š DATUNG</button>
  <button onclick="loadData('getRBM')">ðŸš¶ RUTE BACA METER</button>
  <button onclick="logout()">Keluar</button>
</div>

<div class="container hidden" id="dataBox">
  <button onclick="backMenu()">Kembali</button>
  <div class="filter-box">
    <select id="filterColumn" onchange="applyFilter()">
      <option value="">--Sort kolom--</option>
    </select>
    <div class="radio-group">
      <input type="radio" name="sortDir" value="asc" checked> Aâ†’Z
      <input type="radio" name="sortDir" value="desc"> Zâ†’A
    </div>
    <!-- Filter dropdown multi-select -->
    <div id="multiFilterBox"></div>
  </div>
  <input type="text" id="searchInput" placeholder="Cari..." onkeyup="applyFilter()">
  <div id="loading" class="hidden">Loading...</div>
  <div id="dataList"></div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyulWFkqSoTsBWF9rtyb26U_HYHEweRpnSr1xktxPYovj3Gdu0AxTJFYuUZWvexvdSF/exec"; // ganti dengan URL Apps Script
let currentUser="";
let currentData=[];
let currentAction="";
let multiFilterCols=["LEMBAR","TARIF","DAYA","RBM"];

async function login(){
  const username=document.getElementById("username").value;
  const password=document.getElementById("password").value;
  if(!username||!password){document.getElementById("errorMsg").innerText="Isi username & password";return;}
  document.getElementById("errorMsg").innerText="";
  try{
    const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"login",username,password})});
    const data=await res.json();
    if(data.status==="success"){
      currentUser=data.USER;
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("summaryBox").innerHTML=`
        TOTAL PELANGGAN RBM : ${data.total_pelanggan_RBM}<br>
        Total tagihan + admin : ${data.total_tagihan}<br>
        Total plg 1 lembar : ${data.total_lembar_1}<br>
        Total plg 2 lembar : ${data.total_lembar_2}<br>
        Total plg 3 lembar : ${data.total_lembar_3}
      `;
      document.getElementById("menuBox").classList.remove("hidden");

      // pivot RBM
      fetch(API_URL,{method:"POST",body:JSON.stringify({action:"getDatung",USER:currentUser})})
        .then(r=>r.json())
        .then(d=>{
          const rbmCounts={};
          d.data.forEach(item=>{
            if(item.RBM) rbmCounts[item.RBM]=(rbmCounts[item.RBM]||0)+1;
          });
          let pivotHtml="<b>Jumlah per RBM:</b><br>";
          for(let rbm in rbmCounts){ pivotHtml+=`${rbm} : ${rbmCounts[rbm]}<br>`;}
          document.getElementById("pivotBox").innerHTML=pivotHtml;
        });
    } else {document.getElementById("errorMsg").innerText="Username/password salah";}
  }catch(err){document.getElementById("errorMsg").innerText="Gagal koneksi ke server";}
}

async function loadData(action){
  currentAction=action;
  document.getElementById("menuBox").classList.add("hidden");
  document.getElementById("dataBox").classList.remove("hidden");
  document.getElementById("loading").classList.remove("hidden");
  document.getElementById("dataList").innerHTML="";
  document.getElementById("filterColumn").innerHTML='<option value="">--Sort kolom--</option>';
  document.getElementById("multiFilterBox").innerHTML="";
  try{
    const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action,USER:currentUser})});
    const data=await res.json();
    currentData=data.data;
    if(currentData.length>0){
      Object.keys(currentData[0]).forEach(k=>{
        const opt=document.createElement("option"); opt.value=k; opt.text=k; document.getElementById("filterColumn").appendChild(opt);
      });
      // dropdown multi-select
      multiFilterCols.forEach(col=>{
        if(currentData[0][col]!==undefined){
          let values=[...new Set(currentData.map(d=>d[col]))];
          let sel=document.createElement("select");
          sel.setAttribute("multiple","multiple");
          sel.setAttribute("data-col",col);
          sel.style.width="100%"; sel.style.marginTop="5px"; sel.onchange=applyFilter;
          let optAll=document.createElement("option"); optAll.value=""; optAll.text="Semua"; optAll.selected=true; sel.appendChild(optAll);
          values.forEach(v=>{ let o=document.createElement("option"); o.value=v; o.text=v; o.selected=true; sel.appendChild(o); });
          let label=document.createElement("label"); label.innerText=`Filter ${col}:`; document.getElementById("multiFilterBox").appendChild(label);
          document.getElementById("multiFilterBox").appendChild(sel);
        }
      });
    }
    applyFilter();
  } catch(err){document.getElementById("dataList").innerText="Gagal ambil data";}
  document.getElementById("loading").classList.add("hidden");
}

function renderData(list){
  const container=document.getElementById("dataList");
  container.innerHTML="";
  if(list.length===0){container.innerHTML="<div>Tidak ada data</div>";return;}
  list.forEach(item=>{
    container.innerHTML+=`
      <div class="modern-card">
        <div class="title">${item["NAMA PLG"]||item.NAMA||"-"}</div>
        <div class="row"><span>IDPEL</span><b>${item.IDPEL||"-"}</b></div>
        <div class="row"><span>RBM</span><b>${item.RBM||"-"}</b></div>
        <div class="row"><span>LGK</span><b>${item.LGK||"-"}</b></div>
        <div class="row"><span>LEMBAR</span><b>${item.LEMBAR||"-"}</b></div>
        <div class="row"><span>RPTAGIHAN</span><b>${item.RPTAGIHAN||"-"}</b></div>
        ${item.VERIFIKASI?`<div class="row"><span>Status</span><b style="color:red">${item.VERIFIKASI}</b></div>`:""}
      </div>`;
  });
}

function applyFilter(){
  let list=[...currentData];
  // sort
  const col=document.getElementById("filterColumn").value;
  const dir=document.querySelector('input[name="sortDir"]:checked').value;
  if(col) list.sort((a,b)=>{
    if(a[col]<b[col]) return dir==="asc"?-1:1;
    if(a[col]>b[col]) return dir==="asc"?1:-1;
    return 0;
  });
  // multi-filter dropdown
  multiFilterCols.forEach(col=>{
    const sel=document.querySelector(`#multiFilterBox select[data-col="${col}"]`);
    if(sel){
      const selected=[...sel.selectedOptions].map(o=>o.value).filter(v=>v!=="");
      if(selected.length>0) list=list.filter(d=>selected.includes(String(d[col])));
    }
  });
  // search
  const keyword=document.getElementById("searchInput").value.toLowerCase();
  if(keyword) list=list.filter(obj=>Object.values(obj).some(val=>String(val).toLowerCase().includes(keyword)));
  renderData(list);
}

function backMenu(){document.getElementById("dataBox").classList.add("hidden");document.getElementById("menuBox").classList.remove("hidden");}
function logout(){currentUser="";document.getElementById("menuBox").classList.add("hidden");document.getElementById("dataBox").classList.add("hidden");document.getElementById("loginBox").classList.remove("hidden");}
</script>

</body>
</html>
